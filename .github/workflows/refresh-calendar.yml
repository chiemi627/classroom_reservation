name: Refresh public calendar

on:
  schedule:
    # every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Call refresh endpoint
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          TOKEN: ${{ secrets.CALENDAR_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$SITE_URL" ]; then echo "Error: SITE_URL not set" >&2; exit 1; fi
          if [ -z "$TOKEN" ]; then echo "Error: CALENDAR_REFRESH_TOKEN not set" >&2; exit 1; fi
          base="${SITE_URL%/}"
          echo "Calling ${base}/api/public-calendar?refresh=1"
          resp_file=$(mktemp)
          # save body to file and capture http status
          http_status=$(curl -sS -w "%{http_code}" -o "$resp_file" \
            -H "x-refresh-token: ${TOKEN}" \
            "${base}/api/public-calendar?refresh=1&fetchTimeoutMs=120000&fetchRetries=5")
          echo "HTTP status: $http_status"
          echo "Response body:"
          sed -n '1,200p' "$resp_file" || true
          if [ "$http_status" -ne 200 ] && [ "$http_status" -ne 202 ]; then
            echo "Non-200/202 response, failing workflow" >&2
            cat "$resp_file" >&2
            exit 1
          fi